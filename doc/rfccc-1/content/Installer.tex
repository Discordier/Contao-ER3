\section[sec:installer]{Installer}

The installer have to provide methods to install, upgrade, downgrade and uninstall an extension.

\begin{figure}[h]
\begin{emp}[Installer Interface](20, 20)
Class.information("InstallationInformation")()(
	"+getVersion() : Version",
	"+getFiles() : array",
	"+getInstalledPackage() : Package",
	"+getTargetPackage() : Package");

Class.installer("Installer")()(
	"+install($objInfo : InstallationInformation, $objVersion : Version) throws InstallerException : void",
	"+upgrade($objInfo : InstallationInformation, $objTargetVersion : Version) throws InstallerException : void",
	"+downgrade($objInfo : InstallationInformation, $objTargetVersion : Version) throws InstallerException : void",
	"+reinstall($objInfo : InstallationInformation, $objTargetVersion : Version) throws InstallerException : void",
	"+uninstall($objInfo : InstallationInformation) throws InstallerException : void",	
	"+clean($objInfo : InstallationInformation) throws InstallerException : void");

topToBottom(20)(information, installer);

drawObjects(information, installer);

clink(dashedLink)(information, installer);
\end{emp}
\caption{Installer interface}
\end{figure}

\DisplCode{install(\$objInfo, \$objVersion)} Installs the extension. It gets the target version to install as argument to make it easer for developers to create multi version installers.

\vspace{.5cm}
\DisplCode{upgrade(\$objInfo, \$objTargetVersion)} Upgrades the extension from one version to another version.

\vspace{.5cm}
\DisplCode{downgrade(\$objInfo, \$objTargetVersion)} Downgrades the extension from one version to another version.

\vspace{.5cm}
\DisplCode{reinstall(\$objInfo, \$objTargetVersion)} Reinstall the extension with a specific version. The target version does not have to be the same, as the installed version. This method can be used to downgrade to a lower version, that is not supported by the \DisplCode{downgrade(..)} method.

\vspace{.5cm}
\DisplCode{uninstall(\$objInfo)} Uninstalls the extension. By definition, this will only uninstall the CONTAO files. All user DATA and Schema Information and data will be kept.

\vspace{.5cm}
\DisplCode{clean(\$objInfo)} Completely clean the installation, removes all files and schema data.

\vspace{.5cm}
The installation process success if there is no exception thrown.

\newpage
\section[sec:basic installer]{Basic Installer}

The Basic Installer is the default implementation of the installer interface.
If the developer does not define an installer for the extension, this installer is used.
In most cases, if the developer needs to add custom install, upgrade, downgrade or uninstall code, the developer create a supimplementation of this class.

\begin{figure}[h]
\begin{emp}[Basic Installer](20, 20)
Class.basicInstaller("BasicInstaller")()(
	"+removeFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+removeContaoFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+removeDataFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+removeUnusedFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+removeUnusedContaoFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+removeUnusedDataFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+copyFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+copyContaoFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+copyUserFiles($objInfo : InstallationInformation) throws InstallerException : void",
	"+removeSchema($objInfo : InstallationInformation) throws InstallerException : void",
	"+safePatchSchema($objInfo : InstallationInformation) throws InstallerException : void",
	"+fullPatchSchema($objInfo : InstallationInformation) throws InstallerException : void");

topToBottom(20)(installer, basicInstaller);

drawObjects(installer, basicInstaller);

clink(transition)(basicInstaller, installer);
\end{emp}
\caption{Basic Installer Implementation}
\end{figure}

% remove methods
\vspace{.5cm}
\DisplCode{removeFiles(\$objInfo)} Removes all CONTAO and DATA files from the installation.

\vspace{.5cm}
\DisplCode{removeContaoFiles(\$objInfo)} Removes all CONTAO files from the installation.

\vspace{.5cm}
\DisplCode{removeDataFiles(\$objInfo)} Removes all DATA files from the installation.

\vspace{.5cm}
\DisplCode{removeUnusedFiles(\$objInfo)} Removes unused CONTAO and DATA files from the installation.

\vspace{.5cm}
\DisplCode{removeUnusedContaoFiles(\$objInfo)} Removes unused CONTAO files from the installation.

\vspace{.5cm}
\DisplCode{removeUnusedDataFiles(\$objInfo)} Removes unused DATA files from the installation.

% copy files methods
\vspace{.5cm}
\DisplCode{copyContaoFiles(\$objInfo)} Copy the files from CONTAO package directory into the installation.

\vspace{.5cm}
\DisplCode{copyDataFiles(\$objInfo)} Copy the files from DATA package directory into the installation.

% schema methods
\vspace{.5cm}
\DisplCode{removeSchema(\$objInfo)} Remove the complete schema and all containing data from the database.

\vspace{.5cm}
\DisplCode{safePatchSchema(\$objInfo)} Add missing or modify existing schema, but does not delete any existing schema information and data.

\vspace{.5cm}
\DisplCode{fullPatchSchema(\$objInfo)} Add missing or modify existing schema, and delete no more existing schema information and data.

\vspace{.5cm}
The basic implementation may look like this. Please note, this is an incomplete, pseudo implementation!

\begin{lstlisting}[caption=Basic Installer Implementation Code]
class BasicInstaller implements Installer
{
	public function install(InstallationInformation \$objInfo, Version \$objVersion)
	{
		$this->copyContaoFiles($objInfo);
		$this->copyDataFiles($objInfo);
		$this->safePatchSchema($objInfo);
	}
	
	public function upgrade(InstallationInformation $objInfo, Version $objToVersion)
	{
		$this->removeUnusedFiles($objInfo);
		$this->safePatchSchema($objInfo);
		$this->copyFiles($objInfo);
	}
	
	public function downgrade(InstallationInformation $objInfo, Version $objToVersion)
	{
		$objVersionCompare = $objInfo->getVersion()->compare($objToVersion);
		
		// check if the versions differ in more than the build number
		if (!$objVersionCompare->isAnotherBuild())
		{
			throw new DowngradeException("Downgrade to another major, minor or revision is not supported.");
		}
		
		$this->removeUnusedFiles($objInfo);
		$this->safePatchSchema($objInfo);
		$this->copyFiles($objInfo);
	}
	
	public function reinstall(InstallationInformation $objInfo, Version $objTargetVersion)
	{
		$this->removeContaoFiles($objInfo);
		$this->safePatchSchema($objInfo);
		$this->copyFiles($objInfo);
	}
	
	public function uninstall(InstallationInformation $objInfo)
	{
		$this->removeContaoFiles($objInfo);
	}
	
	public function clean(InstallationInformation $objInfo)
	{
		$this->removeFiles($objInfo);
		$this->removeSchema($objInfo);
	}
	
	public function removeFiles(InstallationInformation $objInfo)
	{
		$this->removeContaoFiles($objInfo);
		$this->removeDataFiles($objInfo);
	}
	
	public function removeContaoFiles(InstallationInformation $objInfo)
	{
		// remove files from the CONTAO package directory.
		// unregister removed files from $objInfo
	}
	
	public function removeDataFiles(InstallationInformation $objInfo)
	{
		// remove files from the DATA package directory.
		// unregister removed files from $objInfo
	}
	
	public function removeUnusedFiles(InstallationInformation $objInfo)
	{
		$this->removeUnusedContaoFiles($objInfo);
		$this->removeUnusedDataFiles($objInfo);
	}
	
	public function removeUnusedContaoFiles(InstallationInformation $objInfo)
	{
		// remove files from the CONTAO package directory that are unused.
		// unregister removed files from $objInfo
	}
	
	public function removeUnusedDataFiles(InstallationInformation $objInfo)
	{
		// remove files from the DATA package directory that are unused.
		// unregister removed files from $objInfo
	}
	
	public function copyFiles(InstallationInformation $objInfo)
	{
		$this->copyContaoFiles($objInfo);
		$this->copyUserFiles($objInfo);
	}
	
	public function copyContaoFiles(InstallationInformation $objInfo)
	{
		// copy files from the CONTAO package into the installation.
		// register installed files into $objInfo
	}
	
	public function copyUserFiles(InstallationInformation $objInfo)
	{
		// copy files from the DATA package into the installation.
		// register installed files into $objInfo
	}
	
	public function removeSchema(InstallationInformation $objInfo)
	{
		// remove the complete schema
	}
	
	public function safePatchSchema(InstallationInformation $objInfo)
	{
		// add missing schema information and update existing
	}
	
	public function fullPatchSchema(InstallationInformation $objInfo)
	{
		// add missing schema information, update existing and remove no more existing informations.
	}
}
\end{lstlisting}

\section[sec:custom installer code]{Custom Installer Code}

If a developer want's to add custom code, he can make a subclass of the Basic Installer.

\begin{lstlisting}[caption=Custom Installer Code Example]
class CustomInstaller extends BasicInstaller
{
	public function upgrade(InstallationInformation $objInfo, Version $objToVersion)
	{
		// add custom pre-upgrade code here
		
		parent::upgrade($objInfo, $objToVersion);
		
		// add custom post-upgrade code here
	}	
}
\end{lstlisting}
